<?php
$json=$_POST['json_string'];

$obj=json_decode($json, true);

// using SendGrid's PHP Library
// https://github.com/sendgrid/sendgrid-php
// If you are using Composer (recommended)
//require 'vendor/autoload.php';
// If you are not using Composer
require("sendgrid-php/sendgrid-php.php");
$from = new SendGrid\Email($obj['auteur'], $obj['form_email']);
$subject = $obj['titre'];
$personalization = array();
$pieces = explode(",", $obj['form_dest']);
$recp_cnt = count($pieces);
//echo $recp_cnt;

$content = new SendGrid\Content("text/html", '<html><head> <title>Toyota Black Friday</title> <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"> <meta content="text/html; charset=UTF-8"> <!--meta http-equiv="Content-Type" content="text/html; charset=UTF-8"--> <style type="text/css"> body { -webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; margin: 0 !important; } p { margin: 1em 0; } img { outline: 0; } a img { border: none; } p { margin: 1em 0; } @-ms-viewport { width: device-width; }</style> <style type="text/css"> @media only screen and (max-width: 480px) { .container { width: 100% !important; } .footer { width: auto !important; margin-left: 0; } .content-padding { padding: 4px !important; } .mobile-hidden { display: none !important; } .logo { display: block !important; padding: 0 !important; } img { max-width: 100% !important; height: auto !important; max-height: auto !important; } .header img { max-width: 100% !important; height: auto !important; max-height: auto !important; } .photo img { width: 100% !important; max-width: 100% !important; height: auto !important; } .drop { display: block !important; width: 100% !important; float: left; clear: both; } .footerlogo { display: block !important; width: 100% !important; padding-top: 15px; float: left; clear: both; } .nav4, .nav5, .nav6 { display: none !important; } .tableBlock { width: 100% !important; } .responsive-td { width: 100% !important; display: block !important; padding: 0 !important; } .fluid, .fluid-centered { width: 100% !important; max-width: 100% !important; height: auto !important; margin-left: auto !important; margin-right: auto !important; } .fluid-centered { margin-left: auto !important; margin-right: auto !important; } /* MOBILE GLOBAL STYLES - DO NOT CHANGE */ body { padding: 0px !important; font-size: 16px !important; line-height: 150% !important; } h1 { font-size: 22px !important; line-height: normal !important; } h2 { font-size: 20px !important; line-height: normal !important; } h3 { font-size: 18px !important; line-height: normal !important; } /* END OF MOBILE GLOBAL STYLES - DO NOT CHANGE */ } @media only screen and (max-width: 640px) { .container { width: 100% !important; } .mobile-hidden { display: none !important; } .logo { display: block !important; padding: 0 !important; } .photo img { width: 100% !important; height: auto !important; } .nav5, .nav6 { display: none !important; } .fluid, .fluid-centered { width: 100% !important; max-width: 100% !important; height: auto !important; margin-left: auto !important; margin-right: auto !important; } .fluid-centered { margin-left: auto !important; margin-right: auto !important; } .content_padding{ padding:0 !important; } #repiquage tr { padding:0 !important; } #repiquage td{ padding:10px !important; } }</style> <!--[if mso]> <style type="text/css"> /* Begin Outlook Font Fix */ body, table, td { font-family : arial, helvetica, sans-serif; line-height : 1; font-size : 16px; color : #FFFFFF; } /* End Outlook Font Fix */ </style> <![endif]--> </head><body bgcolor="#EFEFEF" text="#808080" style="margin: 0px; ; -webkit-text-size-adjust:none; padding-top : 20px; padding-right : 20px; padding-bottom : 20px; padding-left : 20px;background-color : #EFEFEF; font-family : verdana; line-height : 1; font-size : 16px; color : #F5F5F5; padding : 20px; "> <table cellpadding="0" cellspacing="0" width="100%" style="margin: 17px 0px 0px; min-width: 100%;" > <tbody> <tr> <td style="padding: 0px;" > <div style="text-align: center;font-size:10px;color:black;margin-bottom:10px;"> <font face="verdana"><span><b>Si vous ne visualisez pas ce message, </b><a href="%%view_email_url%%">consultez notre version en ligne.</a></span></font> </div> </td> </tr> </tbody> </table> <table width="100%" border="0" cellpadding="0" cellspacing="0" align="center"> <tbody> <tr> <td align="center"> <table cellspacing="0" cellpadding="0" border="0" width="600" class="container" align="center"> <tbody> <tr> <td> <!-- added the border style here --> <table style="background-color : #231f20; font-size : 16px; font-family : verdana; line-height : 1; color : #F5F5F5; " cellspacing="0" cellpadding="0" bgcolor="#000000" width="100%"> <!-- end of comment --> <tbody> <tr> <td align="center" valign="top"> <table align="left" border="0" cellpadding="0" cellspacing="0" width="100%"> <tbody> <tr> <!-- added padding here --> <td class="content_padding" style="border:0px; padding-bottom : 10px; "> <!-- end of comment --> <table border="0" cellpadding="0" cellspacing="0" width="100%"> <tbody> <tr> <td align="left" valign="top"> <table cellpadding="0" cellspacing="0" width="100%" style="margin: 0px; min-width: 100%;"> <tbody> <tr> <td width="100%" style="padding: 0px;"> <table cellpadding="0" cellspacing="0" width="100%" style="width: 100%; min-width: 100%;" > <tbody> <tr> <td > <table cellspacing="0" cellpadding="0" style="width: 100%;"> <tbody> <tr> <td> <table cellspacing="0" cellpadding="0" style="width: 100%;"> <tbody> <tr> <td valign="top" style="width: 100%;"> <table cellpadding="0" cellspacing="0" width="100%" style="text-align: left; min-width: 100%;" > <tbody> <tr> <td align="left"> <table width="100%" cellspacing="0" cellpadding="0"> <tbody> <tr> <td align="center"><img src="http://image.toyotafrance.fr/lib/fe9813727664057973/m/1/457e135a-cf80-4ece-9d2a-201b08c01202.jpg" height="auto" width="100%" style="height: auto; width: 100%; display: block; padding: 0px; text-align: center;"></td> </tr> </tbody> </table> </td> </tr> </tbody> </table> <table cellpadding="0" cellspacing="0" width="100%" style=" margin: 0px; min-width: 100%;" > <tbody> <tr><br> <td style="padding: 5px 0px 0px;" ><div style="font-family:verdana; color: #fff; text-align: center;font-weight:lighter;font-size:16px;">'.$obj['message'].'</div></td> </tr> </tbody> </table> <table cellpadding="0" cellspacing="0" width="100%" style="min-width: 100%;" > <tbody> <tr> <td style="padding-top: 20px; padding-bottom: 20px;" > <table width="100%" border="0" cellspacing="0" cellpadding="0"> <tbody> <tr> <td align="center"> <table border="0" cellspacing="0" cellpadding="0"> <tbody> <tr> <td align="center" bgcolor="#FF0000" style=" border-radius: 50px; -moz-border-radius: 50px; -webkit-border-radius: 50px; background-color: #db061f;"><a target="_blank" style=" text-decoration: none; display: block; font-family:verdana; font-size: 12px; color: #FFFFFF; text-align: center; background-color: #db061f; padding: 10px; border-radius: 50px; -moz-border-radius: 50px; -webkit-border-radius: 50px;" href="https://www.toyota.fr/blackfriday" title="" alt="En savoir plus">EN SAVOIR PLUS</a></td> </tr> </tbody> </table> </td> </tr> </tbody> </table> </td> </tr> </tbody> </table> </td> </tr> </tbody> </table> </td> </tr> </tbody> </table> </td> </tr> </tbody> </table> <table cellpadding="0" cellspacing="0" width="100%" style="min-width: 100%;" > <tbody> <tr> <td > <table width="100%" cellspacing="0" cellpadding="0"> <tbody> <tr> <td align="center"><img src="http://image.toyotafrance.fr/lib/fe9813727664057973/m/1/dbd68ebf-c51c-4009-9749-239fdb4b8944.png" height="43" width="63" style="display: block; padding: 0px;margin-bottom: 20px; text-align: center; height: 43px; width: 63px;"></td> </tr> </tbody> </table> </td> </tr> </tbody> </table> </td> </tr> </tbody> </table> </td> </tr> <tr> <td align="center" valign="top"> <table cellpadding="0" cellspacing="0" width="100%" style="min-width: 100%;"> <tbody> <tr> <td width="100%" style="padding: 0px;"> <table cellpadding="0" cellspacing="0" width="100%" style="min-width: 100%;" > <tbody> <tr> <td > <div style="text-align: left;padding-left:10px;"> <span style="font-size:8px;">*Pourcentage maximal de remise par rapport au prix TTC conseill&#233; du tarif au 1er novembre 2017. Remise applicable sur une s&#233;lection de v&#233;hicules en stock identifi&#233;s au sein de chaque point de vente participant. Offre non cumulable r&#233;serv&#233;e aux particuliers en France m&#233;tropolitaine les 24 et 25 novembre 2017.</span><span style="font-size:12px;"> </span></div> </td> </tr> </tbody> </table> </td> </tr> </tbody> </table> </td> </tr> </tbody> </table> </td> </tr> </tbody> </table> </td> </tr> </tbody> </table> </td> </tr> </tbody> </table> </td> </tr> </tbody> </table> <table cellpadding="0" cellspacing="0" width="100%" style="margin: 17px 0px 0px; min-width: 100%;" > <tbody> <tr> <td style="padding: 0px;" > <div style="text-align: center;font-size:10px;margin-top:10px;"> <a href="%%unsub_center_url%%">Me d&#233;sabonner</a></div> </td> </tr> </tbody> </table> </body></html> ');
$mail = new SendGrid\Mail();
$mail->setFrom( new SendGrid\Email($obj['auteur'], $obj['form_email']));
$mail->setSubject($subject);
    //$mail->setReplyTo(new SendGrid\Email(null, $CDASH_EMAIL_REPLY));
$mail->addContent($content);
foreach (explode(',', $obj['form_dest']) as $recipient) {
    $personalization = new SendGrid\Personalization();
    $personalization->addTo(new SendGrid\Email(null, $recipient));
    $mail->addPersonalization($personalization);
}




$apiKey = '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';
$sg = new \SendGrid($apiKey);
$response = $sg->client->mail()->send()->post($mail);
echo $response->statusCode();
print_r($response->headers());
echo $response->body();
?>
